name: Check CodeRabbit Review and Label PR

on:
  pull_request_review:
    types: [submitted]

jobs:
  evaluate_codereview:
    if: github.event.review.user.login == 'coderabbitai[bot]'
    runs-on: ubuntu-latest
    permissions:
      # C·∫ßn quy·ªÅn `write` ƒë·ªÉ ƒëƒÉng/s·ª≠a comment v√† label
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR Information
        id: get_pr_info
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Generate Summary from Review Comments
        id: generate_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.get_pr_info.outputs.pr_number }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          # 1. L·∫•y c·∫£ n·ªôi dung (body) v√† link (html_url) c·ªßa comment
          # K·∫øt qu·∫£ tr·∫£ v·ªÅ l√† m·ªôt chu·ªói JSON
          issues_json=$(gh api \
            "repos/${REPO_FULL_NAME}/pulls/${PR_NUMBER}/comments" \
            --jq '[.[] | select(.user.login == "coderabbitai[bot]" and (.body | test("Potential issue"; "i"))) | {body: .body, url: .html_url}]')

          # 2. ƒê·∫øm s·ªë l∆∞·ª£ng issue t·ª´ JSON
          issue_count=$(echo "$issues_json" | jq 'length')
          echo "issue_count=$issue_count" >> $GITHUB_OUTPUT

          # 3. X√¢y d·ª±ng n·ªôi dung comment (b·∫£ng Markdown)
          SUMMARY_BODY="### üîç Ph√¢n t√≠ch t·ª´ CodeRabbit\n\n" # Ti√™u ƒë·ªÅ

          if [ "$issue_count" -gt 0 ]; then
            SUMMARY_BODY="${SUMMARY_BODY}**<font color='red'> t√¨m th·∫•y $issue_count 'Potential issue'.</font>** C·∫ßn ph·∫£i x·ª≠ l√Ω tr∆∞·ªõc khi merge.\n\n"
            SUMMARY_BODY="${SUMMARY_BODY}| V·∫•n ƒë·ªÅ ƒë∆∞·ª£c ph√°t hi·ªán | Xem chi ti·∫øt |\n"
            SUMMARY_BODY="${SUMMARY_BODY}| --- | --- |\n"
            
            # D√πng `jq` ƒë·ªÉ l·∫∑p qua t·ª´ng issue v√† th√™m m·ªôt d√≤ng v√†o b·∫£ng
            # L·∫•y d√≤ng ƒë·∫ßu ti√™n c·ªßa comment ƒë·ªÉ l√†m t√≥m t·∫Øt
            table_rows=$(echo "$issues_json" | jq -r '.[] | "| `\(.body | split("\n")[0])` | [Link t·ªõi comment](\(.url)) |"')
            SUMMARY_BODY="${SUMMARY_BODY}${table_rows}"
          else
            SUMMARY_BODY="${SUMMARY_BODY}**<font color='green'> Tuy·ªát v·ªùi!</font>** Kh√¥ng t√¨m th·∫•y 'Potential issue' n√†o.\n"
          fi

          SUMMARY_BODY="${SUMMARY_BODY}\n\n---\n*B·∫£ng n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông b·ªüi GitHub Actions.*"
          
          echo "summary_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # B∆∞·ªõc m·ªõi: ƒêƒÉng ho·∫∑c c·∫≠p nh·∫≠t comment t√≥m t·∫Øt l√™n PR
      - name: Create or Update Summary Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          pr-number: ${{ steps.get_pr_info.outputs.pr_number }}
          comment-id: ${{ github.event.pull_request.number }}-${{ github.job }} # ID duy nh·∫•t ƒë·ªÉ action bi·∫øt c·∫ßn c·∫≠p nh·∫≠t comment n√†o
          body: ${{ steps.generate_summary.outputs.summary_body }}
          edit-mode: replace

      - name: Set PR status to failure if issue count exceeds threshold
        if: steps.generate_summary.outputs.issue_count > 3
        run: |
          echo "Number of 'Potential issue' comments is greater than 3. Failing the check."
          exit 1

      - name: Add "READY TO MERGE" label if criteria are met
        if: steps.generate_summary.outputs.issue_count < 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.get_pr_info.outputs.pr_number }} --add-label "READY TO MERGE"

      - name: Remove "READY TO MERGE" label if criteria are not met anymore
        if: steps.generate_summary.outputs.issue_count >= 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.get_pr_info.outputs.pr_number }} --remove-label "READY TO MERGE" || true
