# T√™n file: .github/workflows/manage_coderabbit_pr.yml
name: Check CodeRabbit and Manage PR

on:
  # K√≠ch ho·∫°t khi c√≥ commit m·ªõi, PR ƒë∆∞·ª£c m·ªü ho·∫∑c m·ªü l·∫°i
  pull_request:
    types: [opened, synchronize, reopened]
  # K√≠ch ho·∫°t khi CodeRabbit App g·ª≠i b√†i review
  pull_request_review:
    types: [submitted]
  # K√≠ch ho·∫°t khi m·ªôt comment ƒë∆∞·ª£c gi·∫£i quy·∫øt
  pull_request_review_comment:
    types: [resolved]

jobs:
  evaluate_codereview:
    # Job n√†y s·∫Ω lu√¥n ch·∫°y khi ƒë∆∞·ª£c k√≠ch ho·∫°t, kh√¥ng c√≥ 'if' ·ªü ƒë√¢y ƒë·ªÉ tr√°nh l·ªói "skipped"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # ƒê·ªÉ approve, request changes, qu·∫£n l√Ω label
      contents: read       # ƒê·ªÉ checkout code
      checks: read         # ƒê·ªÉ ƒë·ªçc tr·∫°ng th√°i c·ªßa c√°c check kh√°c (quan tr·ªçng cho b∆∞·ªõc "Wait")

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ===================================================================
      # B∆Ø·ªöC DEBUG - CH·∫†Y B∆Ø·ªöC N√ÄY ƒê·ªÇ T√åM T√äN CHECK CH√çNH X√ÅC
      # ===================================================================
      - name: 'DEBUG: List all checks on this commit'
        # Ch·ªâ ch·∫°y khi c√≥ commit m·ªõi ƒë·ªÉ t√¨m ra t√™n check m√† b∆∞·ªõc "Wait" c·∫ßn ch·ªù
        if: github.event_name == 'pull_request'
        run: |
          echo "--- Listing all checks for SHA: ${{ github.event.pull_request.head.sha }} ---"
          gh api "repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/check-runs" --jq '.check_runs[] | {name: .name, status: .status, conclusion: .conclusion}'
          echo "--- End of list ---"
          echo ">>> H√ÉY T√åM T√äN 'name' C·ª¶A CODERABBIT TRONG DANH S√ÅCH TR√äN V√Ä C·∫¨P NH·∫¨T V√ÄO B∆Ø·ªöC TI·∫æP THEO."

      # B∆Ø·ªöC CH·ªú ƒê·ª¢I - S·∫Ω d√πng t√™n b·∫°n t√¨m ƒë∆∞·ª£c ·ªü tr√™n
      - name: Wait for CodeRabbit App review to complete
        # Ch·ªâ ch·∫°y b∆∞·ªõc n√†y khi c√≥ commit m·ªõi, v√¨ c√°c s·ª± ki·ªán kh√°c c√≥ nghƒ©a l√† CodeRabbit ƒë√£ ch·∫°y xong
        if: github.event_name == 'pull_request'
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          # THAY TH·∫æ T√äN B·∫†N T√åM ƒê∆Ø·ª¢C T·ª™ B∆Ø·ªöC DEBUG V√ÄO ƒê√ÇY
          check-name: 'Name-found-in-DEBUG-step' # <-- THAY TH·∫æ T√äN N√ÄY
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          # Th√™m 15 gi√¢y ch·ªù ban ƒë·∫ßu ƒë·ªÉ tr√°nh race condition, ƒë·∫£m b·∫£o check c·ªßa CodeRabbit ƒë∆∞·ª£c t·∫°o tr∆∞·ªõc
          initial-delay-seconds: 15
          wait-interval: 20 # Ch·ªù 20 gi√¢y gi·ªØa c√°c l·∫ßn ki·ªÉm tra
          allowed-conclusions: 'success,failure,neutral,skipped,cancelled'

      # ===================================================================
      # C√ÅC B∆Ø·ªöC PH√ÇN T√çCH G·ªêC C·ª¶A B·∫†N - Gi·ªØ nguy√™n logic
      # ===================================================================
      - name: Generate Summary from Unresolved Comments
        # ƒêi·ªÅu ki·ªán n√†y ƒë·∫£m b·∫£o step ch·ªâ ch·∫°y khi c√≥ context ph√π h·ª£p
        if: |
          github.event_name == 'pull_request' ||
          (github.event_name == 'pull_request_review' && github.event.review.user.login == 'coderabbitai[bot]') ||
          (github.event_name == 'pull_request_review_comment' && github.event.comment.user.login == 'coderabbitai[bot]')
        id: generate_summary
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          graphql_query='
            query($owner: String!, $name: String!, $prNumber: Int!) {
              repository(owner: $owner, name: $name) {
                pullRequest(number: $prNumber) {
                  reviewThreads(first: 100) {
                    nodes {
                      isResolved
                      comments(first: 20) {
                        nodes {
                          author { login }
                          body
                          url
                        }
                      }
                    }
                  }
                }
              }
            }'
          issues_json=$(gh api graphql -f query="$graphql_query" -f owner="$REPO_OWNER" -f name="$REPO_NAME" -F prNumber="$PR_NUMBER" \
            --jq '[.data.repository.pullRequest.reviewThreads.nodes[] | select(.isResolved == false) | .comments.nodes[] | select(.author.login == "coderabbitai" and (.body | contains("_‚ö†Ô∏è Potential issue_")))]')
          issue_count=$(echo "$issues_json" | jq 'length')
          echo "Final issue count is: $issue_count"
          echo "issue_count=$issue_count" >> $GITHUB_OUTPUT
          SUMMARY_BODY="### üîç Ph√¢n t√≠ch t·ª´ CodeRabbit\n\n"
          if [ "$issue_count" -gt 0 ]; then
            SUMMARY_BODY="${SUMMARY_BODY}**<font color='red'> t√¨m th·∫•y $issue_count 'Potential issue' ch∆∞a ƒë∆∞·ª£c gi·∫£i quy·∫øt.</font>** C·∫ßn ph·∫£i x·ª≠ l√Ω tr∆∞·ªõc khi merge.\n\n"
            SUMMARY_BODY="${SUMMARY_BODY}| V·∫•n ƒë·ªÅ ƒë∆∞·ª£c ph√°t hi·ªán | Xem chi ti·∫øt |\n"
            SUMMARY_BODY="${SUMMARY_BODY}| --- | --- |\n"
            table_rows=$(echo "$issues_json" | jq -r '.[] | "| `\(.body | split("\n")[0])` | [Link t·ªõi comment](\(.url)) |"')
            SUMMARY_BODY="${SUMMARY_BODY}${table_rows}"
          else
            SUMMARY_BODY="${SUMMARY_BODY}**<font color='green'> Tuy·ªát v·ªùi!</font>** T·∫•t c·∫£ 'Potential issue' ƒë√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt.\n"
          fi
          SUMMARY_BODY="${SUMMARY_BODY}\n\n---\n*B·∫£ng n√†y ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông b·ªüi GitHub Actions.*"
          echo "summary_body<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUMMARY_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update Summary Comment
        if: steps.generate_summary.conclusion == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ github.event.pull_request.number }}-${{ github.job }}
          body: ${{ steps.generate_summary.outputs.summary_body }}
          edit-mode: replace

      - name: Approve or Request Changes based on Issue Count
        if: steps.generate_summary.conclusion == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "${{ steps.generate_summary.outputs.issue_count }}" -gt 3 ]; then
            echo "Requesting changes because issue count is ${{ steps.generate_summary.outputs.issue_count }}."
            gh pr review $PR_NUMBER --request-changes --body "T·ª± ƒë·ªông y√™u c·∫ßu thay ƒë·ªïi do s·ªë l∆∞·ª£ng 'Potential issue' (${{ steps.generate_summary.outputs.issue_count }}) v∆∞·ª£t qu√° ng∆∞·ª°ng cho ph√©p (3)."
            gh pr edit $PR_NUMBER --remove-label "READY TO MERGE" || true
          else
            echo "Approving because issue count is ${{ steps.generate_summary.outputs.issue_count }}."
            EXISTING_REVIEW_ID=$(gh pr view $PR_NUMBER --json reviews --jq '.reviews[] | select(.author.login == "github-actions[bot]" and .state == "CHANGES_REQUESTED") | .id' | tail -n 1)
            if [ -n "$EXISTING_REVIEW_ID" ]; then
              echo "Dismissing previous 'Changes Requested' review (ID: $EXISTING_REVIEW_ID)."
              gh pr review --dismiss "$EXISTING_REVIEW_ID" --body "C√°c v·∫•n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt, s·ªë l∆∞·ª£ng 'Potential issue' ƒë√£ n·∫±m trong ng∆∞·ª°ng cho ph√©p."
            fi
            gh pr review $PR_NUMBER --approve --body "T·∫•t c·∫£ 'Potential issue' ƒë√£ n·∫±m trong ng∆∞·ª°ng cho ph√©p (${{ steps.generate_summary.outputs.issue_count }} <= 3). S·∫µn s√†ng ƒë·ªÉ merge!"
            gh pr edit $PR_NUMBER --add-label "READY TO MERGE"
          fi
