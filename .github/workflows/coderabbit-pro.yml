name: Check CodeRabbit Review and Label PR

on:
  issue_comment:
    types: [created]

jobs:
  evaluate_codereview:
    # --- THAY ĐỔI QUAN TRỌNG Ở ĐÂY ---
    # Điều kiện mới: lắng nghe comment tóm tắt có chứa "Summary by CodeRabbit"
    if: |
      github.event.issue.pull_request &&
      github.event.comment.user.login == 'coderabbitai[bot]' &&
      contains(github.event.comment.body, 'Summary by CodeRabbit')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Debug Event Data
        run: |
          echo "Workflow triggered by user: ${{ github.event.comment.user.login }}"
          echo "Comment body starts with..."
          echo "${{ github.event.comment.body }}" | head -c 200

      - name: Get PR Number
        id: get_pr_number
        run: |
          pr_number=$(jq --raw-output .issue.number "$GITHUB_EVENT_PATH")
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      - name: Wait for API to be consistent
        run: sleep 15s

      - name: Check for "Potential issue" labels in review comments
        id: check_comments
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.get_pr_number.outputs.pr_number }}
          REPO_FULL_NAME: ${{ github.repository }}
        run: |
          # API này sẽ lấy tất cả các comment review (comment trên từng dòng code)
          comments=$(gh api \
            "repos/${REPO_FULL_NAME}/pulls/${PR_NUMBER}/comments" \
            --jq '.[] | select(.user.login == "coderabbitai[bot]") | .body')

          # Đếm số lượng comment có chứa chuỗi "Potential issue"
          # LƯU Ý: Hãy chắc chắn rằng đây là chuỗi văn bản chính xác
          issue_count=0
          while IFS= read -r comment; do
            if echo "$comment" | grep -q "Potential issue"; then
              issue_count=$((issue_count + 1))
            fi
          done <<< "$comments"

          echo "Found $issue_count 'Potential issue' comments."
          echo "issue_count=$issue_count" >> $GITHUB_OUTPUT

      - name: Set PR status to failure if issue count exceeds threshold
        if: steps.check_comments.outputs.issue_count > 3
        run: |
          echo "Number of 'Potential issue' comments is greater than 3. Failing the check."
          exit 1

      - name: Add "READY TO MERGE" label if criteria are met
        if: steps.check_comments.outputs.issue_count < 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "All checks passed. Adding 'READY TO MERGE' label."
          gh pr edit ${{ steps.get_pr_number.outputs.pr_number }} --add-label "READY TO MERGE"

      - name: Remove "READY TO MERGE" label if criteria are not met anymore
        if: steps.check_comments.outputs.issue_count >= 3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Criteria not met. Removing 'READY TO MERGE' label if it exists."
          gh pr edit ${{ steps.get_pr_number.outputs.pr_number }} --remove-label "READY TO MERGE" || true
