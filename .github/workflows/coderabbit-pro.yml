# File: .github/workflows/coderabbit-pro.yml

name: CodeRabbit Pro – Policy Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  
  issue_comment:
    types: [created]
    if: github.event.sender.type != 'Bot'

permissions:
  contents: read
  pull-requests: write
  issues: write 

jobs:
  gate:
    name: Enforce Code Review Policy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # <<< BƯỚC MỚI: Thêm một khoảng chờ ngắn để Coderabbit App khởi tạo >>>
      - name: Initial delay for Coderabbit to start
        if: github.event_name == 'pull_request'
        run: sleep 30
      
      # <<< SỬA ĐỔI: Chờ Coderabbit hoàn thành review >>>
      - name: Wait for Coderabbit review to complete
        if: github.event_name == 'pull_request'
        uses: lewagon/wait-on-check-action@v1.3.3
        with:
          # QUAN TRỌNG: Tên của status check mà Coderabbit App tạo ra.
          # Hãy kiểm tra tên chính xác trên PR của bạn.
          check-name: 'Coderabbit' 
          
          ref: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 20
          # Đã xóa 'running-timeout' không hợp lệ

      - name: Evaluate CodeRabbit findings
        id: evaluate
        uses: actions/github-script@v7
        with:
          # ... (phần script giữ nguyên, không thay đổi)
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr_number = context.issue.number;
            if (!pr_number) {
              core.setFailed('Could not get PR number from context.');
              return;
            }
            const [reviewComments, issueComments] = await Promise.all([
              github.paginate(github.rest.pulls.listReviewComments, { owner, repo, pull_number: pr_number, per_page: 100 }),
              github.paginate(github.rest.issues.listComments, { owner, repo, issue_number: pr_number, per_page: 100 }),
            ]);
            const allComments = [...reviewComments, ...issueComments];
            
            const searchTerm = '⚠️ Potential issue';
            let potential_issues = 0;
            for (const c of allComments) {
              if (c.user?.type === 'Bot' && c.body?.includes(searchTerm)) {
                potential_issues++;
              }
            }
            core.info(`Found: ${potential_issues} potential issues.`);
            core.setOutput('potential_issues', String(potential_issues));

            if (potential_issues > 3) {
              core.setFailed(`Policy failed: Found ${potential_issues} 'Potential issue' comments (threshold is >3).`);
            }

      - name: Update Summary Comment
        if: always()
        # ... (phần này giữ nguyên, không thay đổi)
        
      - name: Add "READY TO MERGE" label
        if: success() && steps.evaluate.outputs.potential_issues == '0'
        # ... (phần này giữ nguyên, không thay đổi)
